<!-- TODO: File and Registry event handling (technically handled by syscheck) -->
<!-- TODO: RDP and SSH logs (although SSH should be fine) -->

<!-- Active Directory attacks -->
<group name="security_event, windows,">
    <!-- DCSync attacks -->
    <rule id="110001" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4662$</field>
        <field name="win.eventdata.properties" type="pcre2">{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}|{19195a5b-6da0-11d0-afd3-00c04fd930c9}</field>
        <options>no_full_log</options>
        <description>Directory Service Access. Possible DCSync attack</description>
    </rule>
 
    <!-- Ignore Directory Service Access originating from machine accounts containing $ -->
    <rule id="110009" level="0">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4662$</field>
        <field name="win.eventdata.properties" type="pcre2">{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}|{19195a5b-6da0-11d0-afd3-00c04fd930c9}</field>
        <field name="win.eventdata.SubjectUserName" type="pcre2">\$$</field>
        <options>no_full_log</options>
        <description>Ignore all Directory Service Access that is originated from a machine account containing $</description>
    </rule>
    
    <!-- Keberoasting attacks -->
    <rule id="110002" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4769$</field>
        <field name="win.eventdata.TicketOptions" type="pcre2">0x40810000</field>
        <field name="win.eventdata.TicketEncryptionType" type="pcre2">0x17</field>
        <options>no_full_log</options>
        <description>RC4 ticket requested. Possible Keberoasting attack</description>
    </rule>
 
    <!-- Golden Ticket attacks -->
    <rule id="110003" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4624$</field>
        <field name="win.eventdata.LogonGuid" type="pcre2">{00000000-0000-0000-0000-000000000000}</field>
        <field name="win.eventdata.logonType" type="pcre2">3</field>
        <options>no_full_log</options>
        <description>Possible Golden Ticket attack</description>
    </rule>

    <!-- This rule detects when PsExec is launched remotely to perform lateral movement within the domain. The rule uses Sysmon events collected from the domain controller. -->
    <rule id="110004" level="12">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID" type="pcre2">17|18</field>
        <field name="win.eventdata.PipeName" type="pcre2">\\PSEXESVC</field>
        <options>no_full_log</options>
        <description>PsExec service launched for possible lateral movement within the domain</description>
    </rule>

    <!-- This rule detects NTDS.dit file extraction using a sysmon event captured on the domain controller -->
    <rule id="110006" level="12">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">NTDSUTIL</field>
        <description>Possible NTDS.dit file extraction using ntdsutil.exe</description>
    </rule>

    <!-- This rule detects Pass-the-hash (PtH) attacks using windows security event 4624 on the compromised endpoint -->
    <rule id="110007" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4624$</field>
        <field name="win.eventdata.LogonProcessName" type="pcre2">seclogo</field>
        <field name="win.eventdata.LogonType" type="pcre2">9</field>
        <field name="win.eventdata.AuthenticationPackageName" type="pcre2">Negotiate</field>
        <field name="win.eventdata.LogonGuid" type="pcre2">{00000000-0000-0000-0000-000000000000}</field>
        <options>no_full_log</options>
        <description>Possible Pass the hash attack</description>
    </rule>
  
    <!-- This rule detects credential dumping when the command sekurlsa::logonpasswords is run on mimikatz -->
    <rule id="110008" level="12">
        <if_sid>61612</if_sid>
        <field name="win.eventdata.TargetImage" type="pcre2">(?i)\\\\system32\\\\lsass.exe</field>
        <field name="win.eventdata.GrantedAccess" type="pcre2">(?i)0x1010</field>
        <description>Possible credential dumping using mimikatz</description>
    </rule>

    <rule id="111010" level="8">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4768$</field>
        <options>no_full_log</options>
        <description>Kerberos TGT requested. Possible AS-REP roasting attack. </description>
    </rule>

    <!-- PetitPotam rules -->
    <rule id="111011" level="5">
	    <if_sid>60001</if_sid>
	    <field name="win.system.EventID">^5145$</field>
	    <options>no_full_log</options>
        <description>A network share object was checked to see whether client can be granted desired access</description>
    </rule>
    <rule id="111012" level="12">
	    <if_sid>111011</if_sid>
	    <field name="win.eventdata.subjectusername">^$</field>
	    <options>no_full_log</options>
	    <description>Event 5145 with empty user</description>
    </rule>
    <rule id="111013" level="12">
        <if_sid>111011</if_sid>
        <field name="win.eventdata.subjectusername">^ANONYMOUS LOGON$</field>
        <options>no_full_log</options>
        <description>Potential Petitpotam vulnerability exploitation</description>
    </rule>
</group>

<group name="windows,adcs">
    <rule id="111020" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4886$</field>
        <options>no_full_log</options>
        <description>Certificate Services received a certificate request.</description>
    </rule>
    <rule id="111021" level="8">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4887$</field>
        <options>no_full_log</options>
        <description>Certificate Services approved a certificate request and issued a certificate.</description>
    </rule>
    <rule id="111022" level="10">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4876$</field>
        <options>no_full_log</options>
        <description>Certificate Services backup started.</description>
    </rule>
    <rule id="111023" level="10">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4877$</field>
        <options>no_full_log</options>
        <description>Certificate Services backup completed.</description>
    </rule>
    <rule id="111024" level="7">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^5058$</field>
        <options>no_full_log</options>
        <description>Key File Operation (Key file was accessed). See event fields for more details</description>
    </rule>
    <rule id="111025" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^5061$</field>
        <options>no_full_log</options>
        <description>Cryptographic operation. Check if a user is opening the CA's private key.</description>
    </rule>
    <rule id="111026" level="8">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^5059$</field>
        <options>no_full_log</options>
        <description>Key migration operation. Potential export of cryptographic key</description>
    </rule>
    <rule id="111027" level="7">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4899$</field>
        <options>no_full_log</options>
        <description>Certificate Services template modified.</description>
    </rule>
    <rule id="111028" level="7">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4900$</field>
        <options>no_full_log</options>
        <description>Certificate Services template security modified.</description>
    </rule>
    <rule id="111029" level="11">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4875$</field>
        <options>no_full_log</options>
        <description>Certificate Services recieved a request to shut down</description>
    </rule>
    <rule id="111030" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4881$</field>
        <options>no_full_log</options>
        <description>Certificate Services stopped</description>
    </rule>
    <rule id="111031" level="12">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4880$</field>
        <options>no_full_log</options>
        <description>Certificate Services started</description>
    </rule>
        <rule id="111032" level="9">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4882$</field>
        <options>no_full_log</options>
        <description>Certificate Authority ACL modified</description>
    </rule>
</group>

<!-- Commonly abused Windows binaries -->
<group name="nltest">
    <rule id="110101" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)nltest\s+\/domain_trusts</field>
        <description>Network Location Test enumerating active directory.</description>
        <mitre>
            <id>T1482</id>
        </mitre>
    </rule>
    <rule id="110102" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)nltest\s+\/dclist|nltest\s+\/dsgetdc</field>
        <description>Network Location Test enumerating remote domain controllers.</description>
        <mitre>
            <id>T1018</id>
        </mitre>
    </rule>
    <rule id="110103" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)nltest\s+\/parentdomain</field>
        <description>Network Location Test enumerating parent domain of a local machine.</description>
        <mitre>
            <id>T1016</id>
        </mitre>
    </rule>
</group>

<group name="bcdedit">
    <rule id="110121" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)BCDEdit\s+/set|BCDEdit.exe\s+/set</field>
        <description>BCDEdit set an entry option.</description>
        <mitre>
            <id>T1490</id>
        </mitre>
    </rule>
    <rule id="110122" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)BCDEdit\s+/f\s+/delete|BCDEdit\s+/delete|BCDEdit.exe\s+/f\s+/delete|BCDEdit.exe\s+/delete</field>
        <description>BCDEdit deleted an element from a specified entry.</description>
        <mitre>
            <id>T1490</id>
        </mitre>
    </rule>
    <rule id="110123" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)BCDEdit.exe\s+/import|BCDEdit\s+/import</field>
        <description>BCDEdit imported a file to restore the state of the system store.</description>
        <mitre>
            <id>T1490</id>
        </mitre>
    </rule>
</group>

<group name="vssadmin">
    <rule id="110131" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)VSSADMIN\s+delete\s+shadows|VSSADMIN.exe\s+delete\s+shadows</field>
        <description>vssadmin deleted shadow copies.</description>
        <mitre>
            <id>T1490</id>
        </mitre>
    </rule>
    <rule id="110132" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)VSSADMIN\s+resize\s+shadowstorage|VSSADMIN.exe\s+resize\s+shadowstorage</field>
        <description>vssadmin resized a shadow copy storage.</description>
        <mitre>
            <id>T1490</id>
        </mitre>
    </rule>
</group>

<group name="attrib">
    <rule id="110141" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)ATTRIB\s+\+h|ATTRIB.EXE\s+\+h|ATTRIB\s+\+s\s+\+h|ATTRIB.exe\s+\+s\s+\+h</field>
        <description>attrib was used to hide files or directories. Current directory: $(win.eventdata.currentDirectory).</description>
        <mitre>
            <id>T1564.001</id>
        </mitre>
    </rule>
</group>

<group name="schtasks">
    <rule id="110151" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)SCHTASKS\s+/CREATE|SCHTASKS.EXE\s+/CREATE</field>
        <description>schtasks attempted to create a new task: $(win.eventdata.commandLine).</description>
        <mitre>
            <id>T1053.005</id>
        </mitre>
    </rule>
    <rule id="110152" level="7">
        <if_sid>110151</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\/XML\s.+.XML</field>
        <description>schtasks created a new task using an XML file: $(win.eventdata.commandLine).</description>
        <mitre>
            <id>T1053.005</id>
        </mitre>
    </rule>
    <rule id="110153" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)SCHTASKS\s+/Delete|SCHTASKS.EXE\s+/Delete</field>
        <description>schtasks attempted to delete a scheduled task: $(win.eventdata.commandLine).</description>
        <mitre>
            <id>T1053.005</id>
        </mitre>
    </rule>
</group>

<!-- Sharphound execution -->
<group name="sharphound">
    <!-- This rule detects the organization name, SpecterOps in the binary.-->
    <rule id="111151" level="7">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.company" type="pcre2">^SpecterOps$</field>
        <description>Possible Bloodhound activity: Sharphound binary executed. </description>
        <mitre>
            <id>T1033</id>
        </mitre>
    </rule>

    <!-- This rule detects the CollectionMethods flag, sometimes specified when running the executable.-->
    <rule id="111152" level="12">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)[c-z]:\\\\Windows\\\\System32\\\\.+\\\\(powershell|cmd)\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)((--CollectionMethods\s)((.+){1,12})|(\s(--Loop)))</field>
        <description>Possible Bloodhound activity: CollectionMethods flag detected.</description>
        <mitre>
            <id>T1059.00</id>
            <id>T1033</id>
        </mitre>
    </rule>  

    <!-- This rule detects the launch of the SharpHound PowerShell cmdlet.-->
    <rule id="111153" level="12">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)[c-z]:\\\\Windows\\\\System32\\\\.+\\\\(powershell|cmd)\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)((invoke-bloodhound\s)|(get-bloodHounddata\s))</field>
        <description>Possible Bloodhound activity: Sharphound Powershell cmdlet detected. </description>
        <mitre>
            <id>T1059.00</id>
            <id>T1033</id>
        </mitre>
    </rule>

    <!-- This rule detects attempts made by an executable to query LDAP-->
    <rule id="111154" timeframe="1" level="3">
        <if_sid>61605</if_sid>
        <field name="win.eventdata.image" type="pcre2">(?i)^[c-z](([^\\]+?)(.*)(\.exe|ps1)$)</field>
        <field name="win.eventdata.destinationPort" type="pcre2">^389$</field>
        <description>LDAP query detected by $(win.eventdata.image) binary on $(name) host.</description>
        <mitre>
            <id>T1560</id>
        </mitre>
    </rule>

    <!-- This rule detects the creation of JSON files containing sensitive AD information
    obtained by the ingestor from the AD-->
    <rule id="111155" timeframe="2" frequency="2" level="7">
        <if_sid>61613</if_sid>
        <field name="win.eventdata.image" type="pcre2">\.exe</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)([^\\]+?)(_computers\.json$|_domains\.json$|_ous\.json$|_users\.json$|_groups\.json$|_containers\.json$|_gpos\.json$)</field>
        <description>Possible Bloodhound activity detected: $(win.eventdata.targetFilename) file created by $(win.eventdata.image).</description>
        <mitre>
            <id>T1036</id>
        </mitre>
    </rule>
    
    <!-- This rule detects the creation of a zip file by an executable binary-->
    <rule id="111156" level="3">
        <if_sid>61613</if_sid>
        <field name="win.eventdata.image" type="pcre2">\.exe</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\.*?([^\\]+\.(zip))$</field>
        <description>Zip file created: compressed data $(win.eventdata.targetFilename) created by $(win.eventdata.image).</description>
        <mitre>
            <id>T1560</id>
        </mitre>
    </rule>
</group>
<group name="nullsession-connection">
    <!-- This rule detects attempts to enumerate DC through null session connections.-->
    <rule id="111157" frequency="2" timeframe="3" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID" type="pcre2">^5145$</field>
        <field name="win.eventdata.relativeTargetName" type="pcre2">^srvsvc|lsarpc|samr$</field>
        <field name="win.eventdata.subjectUserName" type="pcre2">^(?!.*\$$).*$</field>
        <description> Possible Network Service enumeration by $(win.eventdata.subjectUserName) targeting $(win.eventdata.relativeTargetName).</description>
        <mitre>
            <id>T1087</id>
        </mitre>
    </rule>
</group>

<!-- Custom Sysmon rules I "borrowed" from Wazuh blogs -->
<group name="windows,sysmon">
    <!-- my my cats -->
    <rule id="111200" level="12">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image">mimikatz.exe</field>
        <description>Sysmon - Suspicious Process - mimikatz.exe</description>
    </rule>
   <rule id="111201" level="12">
        <if_group>sysmon_event8</if_group>
        <field name="win.eventdata.sourceImage">mimikatz.exe</field>
        <description>Sysmon - Suspicious Process mimikatz.exe created a remote thread</description>
   </rule>
   <rule id="111202" level="12">
        <if_group>sysmon_event_10</if_group>
        <field name="win.eventdata.sourceImage">mimikatz.exe</field>
        <description>Sysmon - Suspicious Process mimikatz.exe accessed $(win.eventdata.targetImage)</description>
   </rule>

    <!-- Scheduled Tasks (again) -->
    <rule id="111210" level="6">
        <if_group>windows</if_group>
        <field name="win.eventdata.ruleName" type="pcre2">^technique_id=T1053,technique_name=Scheduled Task$</field>
        <field name="win.eventdata.eventType" type="pcre2">^CreateKey$</field>
        <description>A Newly Scheduled Task has been Detected on $(win.system.computer)</description>
        <mitre>
            <id>T1053</id>
        </mitre>
    </rule>
    <rule id="111211" level="0">
        <if_sid>111210</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2">^HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tree\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator$</field>
        <description>Suppression rule for scheduled task created by update orchestrator</description>
    </rule>

    <!-- Screensaver persistence -->
    <rule id="111220" level="7">
        <if_sid>61613</if_sid>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)\.scr</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:(\\\\Windows\\\\System32)</field>
        <description>A screensaver file $(win.eventdata.targetFilename) was added to the System32 folder. </description>
        <mitre>
            <id>T1546</id>
        </mitre>
    </rule>
    <rule id="111221" level="12">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\.scr</field>
        <field name="win.eventdata.image" type="pcre2">(?i)cmd.exe</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i).\/s</field>
        <description>A screensaver file $(win.eventdata.parentCommandLine) has executed the cmd process.</description>
        <mitre>
            <id>T1546</id>
        </mitre>
    </rule>

    <!-- Process Injection -->
    <rule id="111230" level="12">
        <if_sid>61610</if_sid>
        <description>Possible process injection activity detected from "$(win.eventdata.sourceImage)" on "$(win.eventdata.targetImage)"</description>
        <mitre>
            <id>T1055.001</id>
        </mitre>
    </rule>
    <rule id="111231" level="0">
        <if_sid>111230</if_sid>
        <field name="win.eventdata.sourceImage" type="pcre2">(C:\\\\Windows\\\\system32)|chrome.exe</field>
        <description>Ignore Windows binaries and Chrome</description>
    </rule>
    <!-- Process Hollowing -->
    <rule id="111232" level="12">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID">^25$</field>
        <description>Process injection activity detected: "$(win.eventdata.Image)" has been tampered with</description>
        <mitre>
            <id>T1055.012</id>
        </mitre>
    </rule>
  
    <!-- PsExec Detection (again) -->
    <rule id="111240" level="10">
        <if_group>windows,sysmon</if_group>
        <field name="win.eventdata.eventType" type="pcre2" >SetValue</field>
        <field name="win.eventdata.targetObject" type="pcre2" >\\\\SOFTWARE\\\\Sysinternals\\\\PsExec\\\\EulaAccepted</field>
        <options>no_full_log</options>
        <description>PsExec EULA registry found on $(win.system.computer)</description>
        <mitre>
            <id>T1112</id>
        </mitre>
    </rule>
    <rule id="111241" level="10">
        <if_group>windows,sysmon</if_group>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\PSEXESVC</field>
        <field name="win.eventdata.eventType" type="pcre2" >^SetValue$</field>
        <field name="win.eventdata.user" type="pcre2" >NT AUTHORITY\\\\SYSTEM</field>
        <options>no_full_log</options> 
        <description>PsExec service running as $(win.eventdata.user) has been created on $(win.system.computer)</description>
        <mitre>
            <id>T1543.003</id>
        </mitre>
    </rule>  
    <rule id="111242" level="10">
        <if_group>windows,sysmon</if_group>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\PSEXESVC</field>
        <field name="win.eventdata.eventType" type="pcre2" >^DeleteKey$</field>
        <field name="win.eventdata.user" type="pcre2" >NT AUTHORITY\\\\SYSTEM</field>
        <options>no_full_log</options>
        <description>PsExec service running as $(win.eventdata.user) has been deleted on $(win.system.computer)</description>
        <mitre>
            <id>T1543.003</id>
        </mitre>
    </rule>
    <rule id="111243" level="10">
        <if_group>windows,sysmon</if_group>
        <field name="win.eventdata.eventType" type="pcre2" >CreatePipe</field>
        <field name="win.eventdata.image" type="pcre2" >\\\\PSEXESVC.exe</field>
        <match type="pcre2">(?i)(PSEXESVC|stdin|stdout|stderr)</match>
        <field name="win.eventdata.user" type="pcre2" >NT AUTHORITY\\\\SYSTEM</field>
        <options>no_full_log</options> 
        <description>PsExec named pipe running as $(win.eventdata.user) has been found on $(win.system.computer)</description>
        <mitre>
            <id>T1570</id>
        </mitre>
    </rule>

    <rule id="111252" level="10">
        <if_group>windows</if_group>
        <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1073,technique_name=DLL Side-Loading</field>
        <description>DLL Side-Loading Detected on $(win.system.computer)</description>
        <mitre>
            <id>T1073</id>
            <id>T1574.002</id>
        </mitre>
    </rule>

    <rule id="111253" level="10">
        <if_group>windows</if_group>
        <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1218.010,technique_name=Regsvr32</field>
        <description>Signed Binary Proxy Execution using Regsvr32 Detected on $(win.system.computer)</description>
        <mitre>
            <id>T1218</id>
            <id>T1117</id>
        </mitre>
    </rule>

    <rule id="111254" level="10">
        <if_group>windows</if_group>
        <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1518.001,technique_name=Security Software Discovery</field>
        <description>Security Software Discovery Attempt has been Detected on $(win.system.computer)</description>
        <mitre>
            <id>T1518</id>
        </mitre>
    </rule>

    <rule id="111255" level="10">
        <if_group>windows</if_group>
        <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1548.002,technique_name=Bypass User Access Control</field>
        <description>Privilege Escalation Through Bypass of UAC has been Detected on $(win.system.computer)</description>
        <mitre>
            <id>T1548.002</id>
            <id>T1088</id>
        </mitre>
    </rule>

    <!-- WMI activities -->
    <rule id="111260" level="6">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID">^19$</field>
        <description>Sysmon - Event 19: WmiEventFilter activity detected</description>
        <options>no_full_log</options>
        <group>sysmon_event_19,</group>
        <mitre>
            <id>T1047</id>
        </mitre>
    </rule>
    <rule id="111261" level="6">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID">^20$</field>
        <description>Sysmon - Event 20: WmiEventConsumer activity detected</description>
        <options>no_full_log</options>
        <group>sysmon_event_20,</group>
         <mitre>
            <id>T1047</id>
        </mitre>
    </rule>
    <rule id="111262" level="6">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID">^21$</field>
        <description>Sysmon - Event 21: WmiEventConsumerToFilter activity detected</description>
        <options>no_full_log</options>
        <group>sysmon_event_21,</group>
         <mitre>
            <id>T1047</id>
        </mitre>
    </rule> 
</group>


<!-- Other Windows logs -->
<!-- Task Scheduler log -->
<group name="windows-custom,windows,task_scheduler,">
    <rule id="111400" level="0">
        <if_sid>60009</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-TaskScheduler$</field>
        <field name="win.system.severityValue">^INFORMATION$</field>
        <options>no_full_log</options>
        <description>Task Scheduler informational event.</description>
    </rule>
    <rule id="111401" level="5">
        <if_sid>111400</if_sid>
        <field name="win.system.eventID">^129$</field>
        <options>no_full_log</options>
        <description>A scheduled task has started</description>
    </rule>
    <rule id="111402" level="5">
        <if_sid>111400</if_sid>
        <field name="win.system.eventID">^141$</field>
        <options>no_full_log</options>
        <description>A scheduled task has been deleted</description>
    </rule>
</group>

<!-- Powershell logs -->
<group name="windows-custom,windows,powershell,">
    <rule id="111500" level="0">
        <if_sid>60009</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
        <description>Powershell-Operational Information Event</description>
    </rule>

    <rule id="111501" level="0">
        <if_sid>60010</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
        <description>Powershell-Operational Warning Event</description>
    </rule>

    <rule id="111502" level="5">
        <if_sid>111501</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
        <field name="win.system.eventID">^4100$</field>
        <description>Powershell Execution Warning, see message for more details</description>
    </rule> 

    <rule id="111503" level="3">
        <if_sid>111500</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
        <field name="win.system.eventID">^4103$</field>
        <description>Powershell cmdlet invoked, see message for more details</description>
    </rule> 

    <rule id="111504" level="3">
        <if_sid>111500</if_sid>
        <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
        <field name="win.system.eventID">^4104$</field>
        <description>Powershell command executed, see message for scriptblock text</description>
    </rule> 

    <rule id="111520" level="0">
        <if_sid>60009</if_sid>
        <field name="win.system.providerName">^Windows PowerShell$</field>
        <description>Powershell Information Event</description>
    </rule>

    <rule id="111521" level="3">
        <if_sid>111520</if_sid>
        <field name="win.system.providerName">^Windows PowerShell$</field>
        <field name="win.system.eventID">^200$</field>
        <description>(placeholder)</description>
    </rule>

    <rule id="111522" level="3">
        <if_sid>111520</if_sid>
        <field name="win.system.providerName">^Windows PowerShell$</field>
        <field name="win.system.eventID">^400$</field>
        <description>Powershell activity started</description>
    </rule>

    <rule id="111523" level="3">
        <if_sid>111520</if_sid>
        <field name="win.system.providerName">^Windows PowerShell$</field>
        <field name="win.system.eventID">^500$</field>
        <description>Powershell Command Executed</description>
    </rule>

    <rule id="111524" level="3">
        <if_sid>111520</if_sid>
        <field name="win.system.providerName">^Windows PowerShell$</field>
        <field name="win.system.eventID">^501$</field>
        <description>Powershell Command Finished</description>
    </rule>
</group>

<!-- Rules for Event IDs that aren't caught under Wazuh's default ruleset -->
<group name="windows-custom,windows,windows_security,">
    <rule id="111601" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4648$</field>
        <options>no_full_log</options>
        <description>Logon attempted using explicit credentials</description>
        <mitre>
            <id>T1078</id>
        </mitre>
    </rule>
    <rule id="111602" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4656$</field>
        <field name="win.eventdata.objectType">^SERVICE OBJECT$</field>
        <options>no_full_log</options>
        <description>The properties of service "$(win.eventdata.objectName)" may have been altered. See message for details</description>
    </rule>
    <rule id="111603" level="11">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4703$</field>
        <field name="win.eventdata.enabledPrivilegeList">SeDebugPrivilege</field>
        <options>no_full_log</options>
        <description>Token Right adjusted - SeDebugPrivilege granted. Potential malicious activity</description>
    </rule>
    <rule id="111604" level="11">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4673$</field>
        <field name="win.eventdata.enabledPrivilegeList">SeTcbPrivilege</field>
        <options>no_full_log</options>
        <description>SeTcbPrivilege used. Potential credential harvesting</description>
    </rule>
    <rule id="111605" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4698$</field>
        <options>no_full_log</options>
        <description>New Task Created</description>
    </rule>
    <rule id="111606" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4688$</field>
        <options>no_full_log</options>
        <description>New Process Created. See command line arguments for more details</description>
    </rule>
    <rule id="111607" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4697$</field>
        <options>no_full_log</options>
        <description>A service was installed in the system</description>
    </rule>
    <rule id="111608" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4702$</field>
        <options>no_full_log</options>
        <description>A Task was modified</description>
    </rule>
    <rule id="111609" level="6">
        <if_sid>60104</if_sid>
        <field name="win.system.eventID">^5152$</field>
        <options>no_full_log</options>
        <description>Windows Firewall - Packet blocked from "$(win.eventdata.sourceAddress)":"$(win.eventdata.sourcePort)" to "$(win.eventdata.destAddress)":"$(win.eventdata.destPort)"</description>
    </rule>
    <rule id="111610" level="5">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^5154$</field>
        <options>no_full_log</options>
        <description>Windows Firewall - Application permitted to listen for connections on "$(win.eventdata.sourceAddress)":"$(win.eventdata.sourcePort)"</description>
    </rule>
    <rule id="111611" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^5156$</field>
        <options>no_full_log</options>
        <description>Windows Firewall - Connection permitted from "$(win.eventdata.sourceAddress)":"$(win.eventdata.sourcePort)" to "$(win.eventdata.destAddress)":"$(win.eventdata.destPort)"</description>
    </rule>
    <rule id="111612" level="6">
        <if_sid>60104</if_sid>
        <field name="win.system.eventID">^5157$</field>
        <options>no_full_log</options>
        <description>Windows Firewall - Connection blocked from "$(win.eventdata.sourceAddress)":"$(win.eventdata.sourcePort)" to "$(win.eventdata.destAddress)":"$(win.eventdata.destPort)"</description>
    </rule>
    <rule id="111613" level="5">
        <if_sid>60104</if_sid>
        <field name="win.system.eventID">^4771$</field>
        <options>no_full_log</options>
        <description>Kerberos Pre-Authentication failed - Mass attempts can indicate spraying</description>
    </rule>
    <rule id="111615" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4672$</field>
        <options>no_full_log</options>
        <description>Special privileges assigned to new logon</description>
    </rule>
    <rule id="111616" level="3">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4724$</field>
        <options>no_full_log</options>
        <description>Attempt made to change password for an account</description>
    </rule>
</group>

<!-- Cobalt Strike rules I "borrowed" from a Wazuh blog -->
<group name="local,cobalt_strike,beaconing,">
    <rule id="111705" level="3">
        <if_sid>61600</if_sid>
        <field name="win.system.eventID">^17$</field>
        <description>A pipe was created. Possible Cobalt Strike activity.</description>
        <mitre>
            <id>T1071</id>
        </mitre>
    </rule>
    
    <rule id="111706" level="14">
        <if_sid>111705</if_sid>
        <field name="win.eventdata.pipeName" type="pcre2">(?i)MSSE-[0-9]{4}-server|msagent_[0-9a-f]{2}|postex</field>
        <description>A named pipe $(win.eventdata.pipeName) associated with Cobalt Strike beaconing activity was created.</description>
        <mitre>
            <id>T1071</id>
        </mitre>
    </rule>
    
    <rule id="111707" level="14">
        <if_sid>111706</if_sid>
        <field name="win.eventdata.pipeName" type="pcre2">(?i)msagent_[0-9a-f]{2}</field>
        <description>A named pipe $(win.eventdata.pipeName) associated with Cobalt Strike SMB beaconing activity was created.</description>
        <mitre>
            <id>T1071</id>
            <id>T1572</id>
        </mitre>
    </rule>
    
    <rule id="111708" level="14">
        <if_sid>111706</if_sid>
        <field name="win.eventdata.pipeName" type="pcre2">(?i)postex_ssh_[0-9a-f]{4}</field>
        <description>A named pipe $(win.eventdata.pipeName) associated with Cobalt Strike SSH beaconing activity was created.</description>
        <mitre>
            <id>T1071</id>
            <id>T1572</id>
        </mitre>
    </rule>

    <rule id="111710" level="0">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.originalFileName" type="pcre2">^sc.exe$</field>
        <description>The service control manager tool was used.</description>
    </rule>
    
    <rule id="111711" level="3">
        <if_sid>111710</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)delete</field>
        <description>A service was deleted. Possible clean up of malicious activity.</description>
        <mitre>
            <id>T1050</id>
            <id>T1070</id>
        </mitre>
    </rule>

    <rule id="111712" level="3">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)curl\.exe.+-s</field>
        <description>Curl - $(win.eventdata.image) - ran in silent mode.</description>
    </rule>
    
    <rule id="111713" level="3">
        <if_sid>111712</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)-o</field>
        <description>Curl ran in silent mode and sent its output to a file.</description>
    </rule>
    
    <rule id="111714" level="10" timeframe="150" frequency="3">
        <if_matched_sid>111713</if_matched_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)-o</field>
        <description>Curl ran in silent mode and sent its output to a file multiple times. Possible beaconing activity.</description>
    </rule>
</group>

<!-- MeshAgent rules -->
<group name="meshagent,tacticalrmm,windows,sysmon">
    <!-- MeshAgent installation -->
    <rule id="111800" level="12">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.image" type="pcre2">\.exe</field>
        <field name="win.eventdata.CommandLine" type="pcre2">(meshagent|mesh).*\.exe.*-fullinstall</field>
        <description>MeshAgent installation</description>
        <mitre>
            <id>T1204.002</id>
            <id>T1036</id>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- MeshAgent creates file -->
    <rule id="111801" level="12">
        <if_sid>61613</if_sid>
        <field name="win.eventdata.image" type="pcre2">\.exe</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Program\sFiles\\\\Mesh\sAgent\\\\MeshAgent\.exe</field>
        <description>Possible MeshAgent folder has been created</description>
        <mitre>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- MeshAgent service registry key detection-->
    <rule id="111802" level="10">
        <if_sid>61614</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\Mesh\sAgent</field>
        <field name="win.eventdata.eventType" type="pcre2" >^CreateKey$</field>
        <field name="win.eventdata.user" type="pcre2" >NT AUTHORITY\\\\SYSTEM</field>
        <description>Registry key created for MeshAgent service</description>
        <mitre>
            <id>T1112</id>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- MeshAgent registry Value detection-->
    <rule id="111803" level="10">
        <if_sid>61615</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\Mesh\sAgent\\\\Type</field>
        <field name="win.eventdata.eventType" type="pcre2" >^SetValue$</field>
        <field name="win.eventdata.user" type="pcre2" >NT AUTHORITY\\\\SYSTEM</field>
        <description>MeshAgent registry modified</description>
        <mitre>
            <id>T1112</id>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- MeshAgent registry key for safe booting detection-->
    <rule id="111804" level="10">
        <if_sid>61614</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Control\\\\SafeBoot\\\\Network\\\\Mesh\sAgent</field>
        <field name="win.eventdata.eventType" type="pcre2" >^CreateKey$</field>
        <field name="win.eventdata.user" type="pcre2" >.</field>
        <description>Registry key created for MeshAgent booting</description>
        <mitre>
            <id>T1534</id>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- MeshAgent firewall rule detection-->
    <rule id="111805" level="12">
        <if_sid>61615</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\SharedAccess\\\\Parameters\\\\FirewallPolicy\\\\FirewallRules</field>
        <field name="win.eventdata.eventType" type="pcre2" >^SetValue$</field>
        <field name="win.eventdata.details" type="pcre2" >\|Action=Allow\|Active=TRUE.*MeshAgent\.exe</field>
        <description>Firewall rule created for MeshAgent service</description>
        <mitre>
            <id>T1543</id>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- Tactical RMM folder creation detection -->
    <rule id="111806" level="12">
        <if_sid>61613</if_sid>
        <field name="win.eventdata.image" type="pcre2">\.exe</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Program\sFiles\\\\TacticalAgent\\\\tacticalrmm\.exe</field>
        <description>Possible TacticalRMM folder has been created</description>
        <mitre>
            <id>T1219</id>
        </mitre>
    </rule>
    <!-- Tactical RMM registry key detection -->
    <rule id="111807" level="10">
        <if_sid>61614</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\SOFTWARE\\\\TacticalRMM</field>
        <field name="win.eventdata.eventType" type="pcre2" >^CreateKey$</field>
        <field name="win.eventdata.user" type="pcre2" >.</field>
        <description>Registry key created for TacticalRMM</description>
        <mitre>
            <id>T1112</id>
            <id>T1219</id>
        </mitre>
    </rule>
</group>

<group name="sliver,">
    <!-- Rule for detecting potential sliver shell execution -->
    <rule id="111820" level="12">
        <if_sid>61603</if_sid>
        <field name="win.eventdata.parentImage" type="pcre2">.exe</field>
        <field name="win.eventdata.image" type="pcre2">powershell.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2"> -NoExit -Command \[Console\]::OutputEncoding=\[Text.UTF8Encoding]::UTF8</field>
        <description>Possible Sliver C2 activity: shell executed: $(win.eventdata.commandLine).</description>
        <mitre>
            <id>T1086</id>
        </mitre>
    </rule>
    <!-- Rule for detecting potential process injection -->
    <rule id="111821" level="9">
        <if_sid>61610</if_sid>
        <field name="win.eventdata.sourceImage" type="pcre2">.exe</field>
        <field name="win.eventdata.targetImage" type="pcre2">C:\\\\Program\ Files\\\\D*[A-Za-z0-9_.]*\\\\[A-Za-z0-9_.]*\\\\[A-Za-z0-9_.]*\\\\[A-Za-z0-9_.]*.exe$</field>
        <description>Suspicious process injection activity detected from $(win.eventdata.sourceImage) on $(win.eventdata.targetImage).</description>
        <mitre>
            <id>T1055</id>
        </mitre>
    </rule>
</group>
<group name="mtls-port,">
    <!-- Command monitoring rule for specific Sliver C2 port communication -->
    <rule id="111822" level="10">
        <if_sid>530</if_sid>
        <match>ossec: output: 'Detecting possible Sliver communication'</match>
        <description>Possible Sliver C2 activity: Detected port 8888 listening.</description>
    </rule>
</group>

<group name='syscheck,'>
    <rule id='100220' level='7'>
   	 <if_sid>550</if_sid>
   	 <field name='file' type='pcre2'>^(?i)'new_dir.*</field>
   	 <description>File modified: $(file)</description>
    </rule>
	

    <rule id='100221' level='7'>
   	 <if_sid>554</if_sid>
   	 <field name='file' type='pcre2'>^(?i)'C:\\\\'.*</field>
   	 <description>File added: $(file)</description>
    </rule>
</group>

<!-- Windows Basics -->
<!-- Chandi Fortnite -->
<group name="windows,users">
  <!-- User created -->
  <rule id="110000" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4720</field>
    <description>
      A user was created.
    </description>
  </rule>

  <!-- User deleted -->
  <rule id="110001" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4726</field>
    <description>
      A user was deleted.
    </description>
  </rule>

  <!-- User sign in (successful) -->
  <rule id="110002" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4624</field>
    <description>
      A user signed in successfully.
    </description>
  </rule>

  <!-- User sign in (failed) -->
  <rule id="110003" level="4">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4625</field>
    <description>
      A user failed to sign in.
    </description>
  </rule>

  <!-- User sign in (successful, as admin) -->
  <rule id="110004" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4624</field>
    <match>.*"win.system.targetUserName":"Administrator".*</match>
    <description>
      Administrator signed in successfully.
    </description>
  </rule>

  <!-- User sign in (failed, as admin) -->
  <rule id="110005" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4625</field>
    <match>.*"win.system.targetUserName":"Administrator".*</match>
    <description>
      Administrator failed to sign in.
    </description>
  </rule>

  <!-- User password change -->
  <rule id="110006" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4723</field>
    <description>
      A user changed their password.
    </description>
  </rule>
  
  <!-- User password reset -->
  <rule id="110011" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4724</field>
    <description>
      A user's password was changed.
    </description>
  </rule>

  <!-- User modification -->
  <rule id="110007" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4738</field>
    <description>
      A user was modified.
    </description>
  </rule>

  <!-- User enabled -->
  <rule id="110008" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4722</field>
    <description>
      A user was enabled.
    </description>
  </rule>

  <!-- User disabled -->
  <rule id="110009" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4725</field>
    <description>
      A user was disabled.
    </description>
  </rule>
  
  <!-- User elevated -->
  <rule id="110010" level="4">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4672</field>
    <description>
      Privileged sign on.
    </description>
  </rule>

  <!-- User Session Started -->
  <rule id="119000" level="4">
    <decoded_as>json</decoded_as>
	  <field name="win.system.providerName">Microsoft-Windows-TerminalServices-LocalSessionManager</field>
    <field name="win.system.eventID">21</field>
    <description>
      A login session was started.
    </description>
  </rule>
</group>

<group name="windows,groups">
  <!-- Group created -->
  <rule id="111000" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4731</field>
    <description>
      A group was created.
    </description>
  </rule>

  <!-- Group deleted -->
  <rule id="111001" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4730</field>
    <description>
      A group was deleted.
    </description>
  </rule>

  <!-- Group membership modified -->
  <rule id="111002" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4732</field>
    <description>
      A user was added to a group.
    </description>
  </rule>
  
  <!-- Group membership modified -->
  <rule id="111005" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4733</field>
    <description>
      A user was removed from a group.
    </description>
  </rule>

  <!-- Administrators group modified -->
  <rule id="111003" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4732</field>
    <match>.*"win.system.targetUserName":"Administrators".*</match>
    <description>
       User was added to Administrators.
    </description>
  </rule>
  
  <!-- Administrators group modified -->
  <rule id="111006" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4733</field>
    <match>.*"win.system.targetUserName":"Administrators".*</match>
    <description>
      A user was removed from Administrators.
    </description>
  </rule>

  <!-- RDP users group modified -->
  <rule id="111004" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4732</field>
    <match>.*"win.system.targetUserName":"Remote Desktop Users".*</match>
    <description>
      A user was added to Remote Desktop Users group.
    </description>
  </rule>
  
  <!-- RDP users group modified -->
  <rule id="111007" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4733</field>
    <match>.*"win.system.targetUserName":"Remote Desktop Users".*</match>
    <description>
      A user was removed from Remote Desktop Users group.
    </description>
  </rule>
</group>

<group name="windows,firewall">
  <!-- Firewall setting changed -->
  <rule id="112000" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4956</field>
    <description>
      The firewall profile was switched.
    </description>
  </rule>

  <!-- Firewall reset to default -->
  <rule id="112001" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4949</field>
    <description>
      The firewall was reset to default settings.
    </description>
  </rule>

  <!-- Firewall rule modified -->
  <rule id="112002" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4947</field>
    <description>
      A firewall rule was modified.
    </description>
  </rule>

  <!-- Firewall rule added -->
  <rule id="112003" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4946</field>
    <description>
      A firewall rule was added.
    </description>
  </rule>

  <!-- Firewall rule deleted -->
  <rule id="112004" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4948</field>
    <description>
      A firewall rule was deleted.
    </description>
  </rule>

  <!-- Firewall disabled -->
  <rule id="112005" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">5025</field>
    <description>
      The firewall was disabled.
    </description>
  </rule>
  
  <!-- Firewall disabled -->
  <rule id="112006" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">5050</field>
    <description>
      The firewall was disabled.
    </description>
  </rule>
</group>

<group name="windows,defender">
  <!-- Defender found malware -->
  <rule id="113000" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">1006</field>
    <field name="win.system.providerName">Microsoft-Windows-Windows Defender</field>
    <description>Windows Defender detected a threat</description>
  </rule>

  <!-- Defender quarentine undone -->
  <rule id="113001" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">1009</field>
    <field name="win.system.providerName">Microsoft-Windows-Windows Defender</field>
    <description>A file was released from quarantine</description>
  </rule>
	
  <!-- Defender RTP disabled -->
  <rule id="113002" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">5001</field>
    <field name="win.system.providerName">Microsoft-Windows-Windows Defender</field>
    <description>Defender real time protection disabled</description>
  </rule>

  <!-- Defender config modified -->
  <rule id="113002" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">5007</field>
    <field name="win.system.providerName">Microsoft-Windows-Windows Defender</field>
    <description>Defender settings modified</description>
  </rule>
</group>

<group name="windows,event_logs">
  <!-- Event log disabled -->
  <rule id="114000" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">1100</field>
    <description>
      An event log was disabled.
    </description>
  </rule>

  <!-- Event log cleared -->
  <rule id="114001" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">1102</field>
    <description>
      An event log was cleared.
    </description>
  </rule>
</group>

<group name="windows,scheduled_tasks">
  <!-- Scheduled task target modified -->
  <rule id="115000" level="9">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4702</field>
    <description>
      A scheduled task was modified.
    </description>
  </rule>

  <!-- Scheduled task deleted -->
  <rule id="115001" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4699</field>
    <description>
      A scheduled task was deleted.
    </description>
  </rule>

  <!-- Scheduled task created -->
  <rule id="115002" level="9">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4698</field>
    <description>
      A scheduled task was created.
    </description>
  </rule>

<!-- Scheduled task enabled -->
  <rule id="115003" level="9">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4700</field>
    <description>
      A scheduled task was enabled.
    </description>
  </rule>

<!-- Scheduled task disabled -->
  <rule id="115004" level="9">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4701</field>
    <description>
      A scheduled task was disabled.
    </description>
  </rule>

  <!-- Scheduled task executed -->
  <rule id="115005" level="3">
    <decoded_as>json</decoded_as>
    <field name="win.system.providerName">TaskScheduler</field>
    <field name="win.system.eventID">200</field>
    <description>Scheduled task executed</description>
  </rule>
</group>

<group name="windows,processes_and_services">
  <!-- Service Created -->
  <rule id="116000" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">7045</field>
    <description>
      A service was created.
    </description>
  </rule>

  <!-- Service Modified -->
  <rule id="116001" level="10">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">7040</field>
    <description>
      A service was modified.
    </description>
  </rule>

  <!-- Service Deleted -->
  <rule id="116002" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">7039</field>
    <description>
      A service was deleted.
    </description>
  </rule>

  <!-- Service Stopped -->
  <rule id="116003" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">7036</field>
    <description>
      A service was stopped.
    </description>
  </rule>

  <!-- Service Started -->
  <rule id="116005" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">7036</field>
    <match>.*"state":"running".*</match>
    <description>
      A service was started.
    </description>
  </rule>

  <!-- Unsigned Executable Launched from Inside System32 -->
  <rule id="116006" level="6">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4688</field>
    <match>.*"newProcessName":"C:\\\\Windows\\\\System32\\\\.*".*</match>
    <match>.*"signatureStatus":"unsigned".*</match>
    <description>
      An unsigned executable was launched from inside the System32 directory.
    </description>
  </rule>

	<!-- Executable Launched from Inside Fonts -->
  <rule id="116008" level="6">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4688</field>
    <match>.*"newProcessName":"C:\\\\Windows\\\\Fonts\\\\.*".*</match>
    <description>
      An executable was launched from inside the fonts directory.
    </description>
  </rule>

  <!-- Executable with Invalid Signature Launched from Inside System32 -->
  <rule id="116007" level="6">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4688</field>
    <match>.*"newProcessName":"C:\\\\Windows\\\\System32\\\\.*".*</match>
    <match>.*"signatureStatus":"invalid".*</match>
    <description>
      An executable with an invalid signature was launched from inside the System32 directory.
    </description>
  </rule>
</group>

<group name="windows,file_system">
  <!-- Modification of System32 -->
  <rule id="117000" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":"C:\\\\Windows\\\\System32\\\\.*".*</match>
    <description>
      System32 was modified.
    </description>
  </rule>

	<!-- Modification of Program Files -->
  <rule id="117003" level="3">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":"C:\\\\Program.*".*</match>
    <description>
      A program data folder was modified.
    </description>
  </rule>

	<!-- Modification of User Files -->
  <rule id="117000" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":"C:\\\\Users.*".*</match>
    <description>
      A user's folder was modified.
    </description>
  </rule>

	<!-- Modification of Fonts folder -->
  <rule id="117000" level="5">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":"C:\\\\Windows\\\\Fonts\\\\.*".*</match>
    <description>
      The fonts folder was modified. This is a common place to hide malware.
    </description>
  </rule>

  <!-- .iso File Written -->
  <rule id="117001" level="14">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":".*\\.iso".*</match>
    <description>
      An .iso file was written. Prepare for death.
    </description>
  </rule>

  <!-- .exe File Written -->
  <rule id="117002" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4663</field>
    <match>.*"objectName":".*\\.exe".*</match>
    <description>
      An .exe file was written.
    </description>
  </rule>
</group>

<group name="windows,registry">
  <!-- Registry Modification -->
  <rule id="118000" level="2">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4657</field>
    <description>
      The registry was modified.
    </description>
  </rule>

  <!-- Modification of Auto Run Registry Key -->
  <rule id="118001" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4657</field>
    <match>.*"keyPath":".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run.*".*</match>
    <description>
      An auto run registry key was modified.
    </description>
  </rule>

  <!-- Modification of Image File Execution Options -->
  <rule id="118002" level="8">
    <decoded_as>json</decoded_as>
    <field name="win.system.eventID">4657</field>
    <match>.*"keyPath":".*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\.*".*</match>
    <description>
      An image file execution options registry key was modified.
    </description>
  </rule>
</group>

<group name="windows,powershell">
  <!-- Session Started -->
  <rule id="119000" level="4">
    <decoded_as>json</decoded_as>
	  <field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.eventID">40962</field>
    <description>
      A PowerShell session was started.
    </description>
  </rule>

  <!-- Block Executed -->
  <rule id="119001" level="2">
    <decoded_as>json</decoded_as>
		<field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.eventID">4104</field>
    <description>
      A PowerShell block was executed.
    </description>
  </rule>

  <!-- PowerShell Running with -encodedCommand -->
  <rule id="119002" level="6">
    <decoded_as>json</decoded_as>
		<field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.eventID">4104</field>
    <match>.*-encodedCommand.*</match>
    <description>
      PowerShell was run with the -encodedCommand parameter. This could be defence evasion.
    </description>
  </rule>

  <!-- PowerShell Logging Disabled -->
  <rule id="119003" level="14">
    <decoded_as>json</decoded_as>
		<field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.eventID">4688</field>
    <match>.*"newProcessName":".*\\\\powershell.*".*</match>
    <match>.*"commandLine":".*Set-ExecutionPolicy.*".*</match>
    <description>
      PowerShell logging was disabled.
    </description>
  </rule>

  <!-- Stop-Service Cmdlet Executed -->
  <rule id="119004" level="14">
    <decoded_as>json</decoded_as>
		<field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <field name="win.system.eventID">4104</field>
    <match>.*Stop-Service.*</match>
    <description>
      The Stop-Service cmdlet was executed in PowerShell. This could be downtime!
    </description>
  </rule>
</group>

